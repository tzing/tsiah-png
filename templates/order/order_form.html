{% load i18n %}
{% load humanize %}
<form class="ui form" method="POST" action="{% url 'order_detail' order.id %}">
    <div class="ui fluid raised card">

        <div class="content">
            <h2 class="ui sub header">{% trans 'Order it!' %}</h2>
        </div>

        <div class="content">
            <!-- who -->
            <div class="required field">
                <label>{% trans 'Who am I' %}</label>

                <div class="ui selection dropdown" id="select-user">
                    <input type="hidden" name="user">
                    <i class="dropdown icon"></i>
                    <div class="default text">{% trans 'who' %}</div>
                    <div class="menu">
                        {% for user in users %}
                        <div class="item" data-value="{{ user.get_username }}">
                            {% if user.get_full_name %}
                            {{ user.get_full_name }}
                            {% else %}
                            {{ user.get_username }}
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div><!-- ./who -->

            <!-- add item -->
            <div class="field">
                <label>{% trans 'Wanna...' %}</label>

                <div class="ui multiple search selection dropdown product" id="select-item">
                    <input type="hidden" name="tickets">
                    <i class="dropdown icon"></i>
                    <div class="default text">{% trans 'select item' %}</div>
                    <div class="menu">
                        {% for product in products %}
                        <div class="item" data-value="{{ product.id }}" data-price="{{ product.price }}" data-name="{{ product.name }}">
                            <div class="ui label">
                                {% if product.category %}{{ product.category }}
                                {% else %}{% trans 'Unsorted' %}
                                {% endif %}
                            </div>
                            {{ product.name }}
                            <small class="price">${{ product.price | intcomma }}</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div><!-- ./add item -->

            <!-- tickets -->
            <table class="ui table">
                <thead>
                    <tr>
                        <th class="four wide">{% trans 'Item' %}</th>
                        <th class="two wide">{% trans 'Quantity' %}</th>
                        <th class="three wide">{% trans 'Price' %}</th>
                        <th class="seven wide">{% trans 'Note' %}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="hint">
                        <td class="center aligned" colspan="4">{% trans 'No tickets' %}</td>
                    </tr>
                </tbody>
            </table><!-- ./tickets -->

            <div class="ui primary submit button">{% trans 'Submit' %}</div>
            <div class="ui reset button">{% trans 'Reset' %}</div>

            <div class="ui error message">
                {% if error_message %}
                <ul class="list">
                    <li>{{ error_message }}</li>
                </ul>
                {% endif %}
            </div>

        </div>
    </div>

    {% csrf_token %}

</form>

<script>
    $('form.form').form({
        'on': 'blur',
        fields: {
            user: {
                identifier: 'user',
                rules: [{
                    type: 'empty',
                    prompt: '{% trans "Please specific a user" %}'
                }]
            },
            tickets: {
                identifier: 'tickets',
                rules: [{
                    type: 'empty',
                    prompt: '{% trans "At least one item should be selected" %}'
                }]
            }
        }
    });

    $('#select-user').dropdown();

    $('#select-item').dropdown({
        fullTextSearch: true,
        match: 'text',

        // on add: create row to order food
        onAdd: function (add_id, _, add_obj) {
            var id = add_id;
            var name = add_obj.data('name');
            var price = add_obj.data('price');

            // remove 'no ticket' row
            $('tr.hint').remove();

            // add row
            var row = $('<tr></tr>').data('id', id);
            $('form.form tbody').append(row);

            // item name
            row.append($('<td></td>').append(name));

            // quantity
            row.append($('<td></td>').append(
                $('<input>')
                    .attr('type', 'number')
                    .attr('name', 'quantity-' + id)
                    .attr('value', 1)
                    .attr('min', 0)
                    .change(function () {
                        $('input[name="price-' + id + '"]').val($(this).val() * price);
                    })
            ));

            // price
            row.append($('<td></td>').append(
                $('<input>')
                    .attr('type', 'number')
                    .attr('name', 'price-' + id)
                    .attr('min', 0)
                    .attr('step', 5)
                    .attr('value', price)
            ));

            // note
            row.append($('<td></td>').append(
                $('<input>')
                    .attr('name', 'note-' + id)
                    .attr('type', 'text')
                    .attr('placeholder', '{% trans "Add something to " %}' + name)
            ));

        },

        // on remove: remove row
        onRemove: function (rm_id, _, _) {
            $('form.form tbody tr').filter(function () {
                if ($(this).data('id') === rm_id) { return this; }
            }).get(-1).remove();
        }

    });
</script>
